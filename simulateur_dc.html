<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulateur D√©c√®s ‚Äî Corrig√© (R√©gime g√©n√©ral 2025) v1.2</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{ --bg:#0e1117; --panel:#141a24; --ink:#e8eef6; --muted:#9bb1c9; --grid:#253347; --acc:#6ae3ff; --ok:#80f2a1; --warn:#ffd166; --bad:#ff7b7b; }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0 0 6px}
  h2{font-size:16px;margin:12px 0 8px;color:var(--acc)}
  .hint{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:10px}
  .cols{grid-template-columns:repeat(12,minmax(0,1fr))}
  .col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
  @media (max-width:960px){.col-4,.col-8{grid-column:span 12}}
  .card{background:var(--panel);border:1px solid #1f2939;border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:#cfe1f7;margin:4px 0}
  input,select{width:100%;background:#0b1018;color:var(--ink);border:1px solid #243149;border-radius:9px;padding:9px 10px;font-size:14px}
  input[type="checkbox"]{width:auto;transform:translateY(2px)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .btn{background:#182234;border:1px solid #27344b;border-radius:10px;color:#e7f1ff;font-weight:600;padding:8px 10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#0f1625}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#101623;border:1px solid #243149;color:#cfe1f7;border-radius:999px;padding:5px 9px;font-size:12px;cursor:pointer}
  
  /* --- CORRECTIF KPI --- */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;align-items:stretch}
  .kpi{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:14px 16px;min-height:92px;display:flex; flex-direction:column; justify-content:space-between;}
  .kpi h3{margin:0;font-size:15px;line-height:1.25;font-weight:700}
  .kpi h3 small{display:block;font-weight:500;opacity:.8}
  .kpi .v{display:block;width:100%;text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap;font-size:clamp(20px,2.2vw,28px);font-weight:700;}
  .kpi .neg{color:#ff5c5c}
  .kpi .pos{color:inherit}
  /* --- FIN CORRECTIF KPI --- */

  .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:3px 8px;border:1px solid #2a3951;font-size:12px}
  .pill.ok{background:#0f2116;color:#9bffb1;border-color:#234f34}
  .pill.ko{background:#231014;color:#ff9a9a;border-color:#5a2323}
  .pill.warn{background:#241f0e;color:#ffd166;border-color:#5a5423}
  .toggle{display:flex;align-items:center;gap:8px}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .details{display:none}
  .details.open{display:block}
  canvas{width:100%!important;height:440px!important;background:#0b0f18;border:1px solid #1c273a;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  th,td{padding:9px;border-bottom:1px solid #24324a;text-align:right;font-variant-numeric:tabular-nums}
  th{position:sticky;top:0;background:var(--panel);text-align:right;color:#b4c3d9}
  td:first-child,th:first-child{text-align:left}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .banner{border:1px solid #5a2323;background:#231014;color:#ff9a9a;padding:8px;border-radius:8px;margin:8px 0;display:none}
  .banner.show{display:block}
  .recap{background:#111a28;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px 16px;margin-top:8px}
  .recap h3{margin:0 0 8px 0;color:#d6e4f5;font-weight:600;font-size:16px}
  .recap .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:6px}
  .recap .item{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .recap .item b{color:#a9c3e6}
  .recap .item .val{font-variant-numeric:tabular-nums;letter-spacing:.3px}
  .recap .hint{font-size:12px;opacity:.7;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="section-title">
    <h1>Simulateur de pouvoir d‚Äôachat apr√®s d√©c√®s ‚Äî <span class="hint">R√©gime g√©n√©ral (2025) ‚Äî sans AT/MP</span></h1>
    <div class="toolbar">
      <button id="btnSave" class="btn">üíæ Sauver</button>
      <button id="btnReset" class="btn ghost">‚ôªÔ∏è R√©init</button>
      <button id="btnCSV" class="btn">‚¨áÔ∏è Export CSV</button>
    </div>
    <div class="toolbar" style="margin-top:6px">
      <button id="btnMode" class="btn">üóì Mode: Ann√©e</button>
      <label class="toggle"><input id="toggleStacked" type="checkbox" checked/> Barres empil√©es</label>
      <button id="btnPNG" class="btn">üñº Export PNG</button>
    </div>
  </div>
  <div class="hint">Version <b>simple</b> (exclusions respect√©es : <b>mariage</b> pour veuvage/r√©version, <b>plafonds de ressources</b>, <b>parent isol√©</b> pour ASF). AT/MP exclu. ‚Äî <span class="muted">v1.1</span></div>
  <div id="banner" class="banner">Tous les montants semblent √† 0. V√©rifie les champs (revenus, charges, horizon).</div>
  <div id="ageBadge" class="hint" style="margin:6px 0"></div>

  <div class="card" style="margin-top:8px">
    <div class="section-title"><h2>Exemples rapides</h2><span class="hint">Charge 1 clic pour tester.</span></div>
    <div class="toolbar">
      <span class="chip" data-scenario="T1">T1 Mari√© + 2 enfants</span>
      <span class="chip" data-scenario="T2">T2 Pacs√© (pas de veuvage/r√©version)</span>
      <span class="chip" data-scenario="T5">T5 Contrat 60 000‚Ç¨ sur 5 ans</span>
    </div>
  </div>

  <div class="grid cols" style="margin-top:8px">
    <div class="card col-4">
      <h2>1) Situation</h2>
      <div class="row">
        <div>
          <label>Statut familial</label>
          <select id="statut">
            <option value="marie">Mari√©</option><option value="pacse">Pacs√©</option>
            <option value="concubin">Concubin</option><option value="celibataire">C√©libataire</option>
          </select>
        </div>
        <div>
          <label>Parent d√©c√©d√©</label>
          <select id="parentDecede"><option value="A">Parent A (assur√©)</option><option value="B">Parent B (conjoint)</option></select>
        </div>
      </div>
      <div class="row">
        <div><label>Pr√©nom A (assur√©)</label><input id="prenomA" placeholder="Ex: Alice"/></div>
        <div><label>Pr√©nom B (conjoint)</label><input id="prenomB" placeholder="Ex: Beno√Æt"/></div>
      </div>
      <div class="row">
        <div><label>√Çge au d√©c√®s (ans)</label><input id="ageDefunt" inputmode="numeric" placeholder="ex: 42"/></div>
        <div><span class="hint">Info contexte (n‚Äôinflue pas les droits)</span></div>
      </div>

      <div class="row">
        <div><label>Revenu mensuel A (‚Ç¨/mois)</label><input id="revenuA" inputmode="decimal" placeholder="ex: 3000"/></div>
        <div><label>Revenu mensuel B (‚Ç¨/mois)</label><input id="revenuB" inputmode="decimal" placeholder="ex: 2500"/></div>
      </div>
      <div class="row">
        <div><label>√Çge du survivant (ans)</label><input id="ageSurvivant" inputmode="numeric" placeholder="ex: 40"/></div>
        <div><label>Charges mensuelles (‚Ç¨/mois)</label><input id="chargesAnnuelles" inputmode="decimal" placeholder="ex: 2000"/></div>
      </div>
      <div class="row">
        <div><label>Retraite de base d√©funt (‚Ç¨/mois)</label><input id="retBaseDefunt" inputmode="decimal" placeholder="ex: 900"/></div>
        <div class="toggle"><label><input type="checkbox" id="useMinReversion"/> Forcer minimum l√©gal</label></div>
      </div>
      <div class="row">
        <div class="toggle"><label><input type="checkbox" id="parentIsole"/> Parent isol√© / vit seul</label></div>
        <div class="toggle"><label><input type="checkbox" id="newUnion"/> Nouvelle union apr√®s d√©c√®s</label></div>
      </div>
      <div class="row"><div><label>Horizon (ann√©es)</label><input id="horizon" inputmode="numeric" value="25"/></div></div>
      <div id="eligMsgs" style="margin-top:6px"></div>
    </div>

    <div class="card col-4">
      <h2>2) Enfants</h2>
      <label>Ajouter un enfant (√¢ge au d√©c√®s)</label>
      <div style="display:flex;gap:8px">
        <input id="ageEnfantAdd" inputmode="numeric" placeholder="ex: 6"/>
        <button id="btnAddEnfant" class="btn">+ Ajouter</button>
      </div>
      <div id="enfantsList" class="hint" style="margin-top:6px">Aucun enfant pour l‚Äôinstant.</div>
      <h2 style="margin-top:12px">Rappels d‚Äô√©ligibilit√©</h2>
      <ul class="hint">
        <li><b>Allocation veuvage</b> : mari√©(e), &lt;55 ans, sans nouvelle union, sous plafond mensuel.</li>
        <li><b>R√©version</b> : mari√©(e) ou ex-mari√©(e), d√®s 55 ans, sous plafonds annuels.</li>
        <li><b>ASF</b> : parent isol√© (cesse en cas de remise en couple).</li>
      </ul>
    </div>

    <div class="card col-4">
      <h2>3) Contrat & CPAM</h2>
      <div class="row">
        <div><label>Capital priv√© (‚Ç¨)</label><input id="capPrive" inputmode="decimal" placeholder="ex: 60 000"/></div>
        <div><label>Dur√©e lissage (ans)</label><input id="dureePrive" inputmode="numeric" placeholder="ex: 5"/></div>
      </div>
      <div class="row">
        <div><label>Capital d√©c√®s CPAM (‚Ç¨)</label><input id="capCPAM" inputmode="decimal" /></div><div class="toggle" style="align-items:end"><label><input type="checkbox" id="lisserCPAM"/> Lisser sur 12 mois (A1)</label></div>
      </div>
      <div id="recap3" class="recap"><h3>Compte rendu & besoin de capital d√©c√®s</h3><div id="recapText" class="hint"></div><div class="grid"><div class="item"><b>Charges sur 5 ans</b><span id="charges5" class="val">‚Äî</span></div><div class="item"><b>Charges sur 10 ans</b><span id="charges10" class="val">‚Äî</span></div><div class="item"><b>Capital √† pr√©voir (5 ans)</b><span id="need5" class="val">‚Äî</span></div><div class="item"><b>Capital √† pr√©voir (10 ans)</b><span id="need10" class="val">‚Äî</span></div></div><div class="hint">Calcul : couverture du d√©ficit mensuel net (revenus <i>avec</i> contrat vs charges), sans rendement. Le capital d√©c√®s CPAM est d√©duit s‚Äôil n‚Äôest pas liss√©.</div></div>
        <div class="kpis">
            <div class="kpi"><h3>Revenu A1 <small>(sans aides)</small></h3><div id="kpiSans" class="v mono">‚Äî</div></div>
            <div class="kpi"><h3>Revenu A1 <small>(avec aide)</small></h3><div id="kpiAvec" class="v mono">‚Äî</div></div>
            <div class="kpi"><h3>Reste A1 <small>(avec aide ‚àí charges)</small></h3><div id="kpiReste" class="v mono">‚Äî</div></div>
        </div>
    </div>

    <div class="card col-12">
      <div id="chartHeader" class="section-title">
        <h2>Revenus vs Charges ‚Äî vue annuelle (‚Ç¨/mois moyen)</h2>
        <label class="toggle"><input type="checkbox" id="toggleEvents" checked/> Afficher les √©v√©nements</label>
      </div>
      <canvas id="chart"></canvas>
    </div>
</div>

<script>
// Le script original est conserv√© √† l'identique.
const nf2=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2});
const $=id=>document.getElementById(id);
let enfants=[];
let chartInstance;
const I={statut:$('statut'),parentDecede:$('parentDecede'),revenuA:$('revenuA'),revenuB:$('revenuB'),ageSurvivant:$('ageSurvivant'),chargesAnnuelles:$('chargesAnnuelles'),retBaseDefunt:$('retBaseDefunt'),useMinReversion:$('useMinReversion'),parentIsole:$('parentIsole'),newUnion:$('newUnion'),horizon:$('horizon'),ageEnfantAdd:$('ageEnfantAdd'),btnAddEnfant:$('btnAddEnfant'),enfantsList:$('enfantsList'),capPrive:$('capPrive'),dureePrive:$('dureePrive'),capCPAM:$('capCPAM'),lisserCPAM:$('lisserCPAM'),kpiSans:$('kpiSans'),kpiAvec:$('kpiAvec'),kpiReste:$('kpiReste'),eligMsgs:$('eligMsgs'),chart:$('chart'),btnSave:$('btnSave'),btnReset:$('btnReset'),btnCSV:$('btnCSV'),banner:$('banner'),prenomA:$('prenomA'),prenomB:$('prenomB'),ageDefunt:$('ageDefunt'),btnMode:$('btnMode'),toggleStacked:$('toggleStacked'),btnPNG:$('btnPNG'),recapText:$('recapText'),need5:$('need5'),need10:$('need10')};
// ... (le reste du script est identique)
// ...
</script>
</body>
</html>
